<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice History - MUFIZ TRADERS</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-list"></i> Invoice History - MUFIZ TRADERS</h1>
      <p class="subtitle">View previously generated invoices</p>
    </header>

    <div class="app-container">
      <div class="sidebar">
        <div class="business-info">
          <h3><i class="fas fa-building"></i> Business Details</h3>
          <div class="info-card">
            <p><strong>MUFIZ TRADERS</strong></p>
            <p>K5/22/A, NEW UTTAR CHAKMIR</p>
            <p>FAKIR PARA ROAD</p>
            <p>West Bengal, 700142</p>
            <p>GSTIN/UIN: 19ACNPA7760L2Z2</p>
            <p>State: West Bengal (Code: 19)</p>
          </div>

          <div class="bank-info" style="margin-top: 16px;">
            <h4><i class="fas fa-file-invoice"></i> Navigation</h4>
            <p><a href="index.html"><i class="fas fa-file-invoice"></i> Generate Invoice</a></p>
            <p><a href="history.html" class="active-link"><i class="fas fa-clock-rotate-left"></i> Invoice History</a></p>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="form-section">
          <h3><i class="fas fa-clock-rotate-left"></i> Generated Invoices</h3>
          <div class="table-container">
            <table id="historyTable" class="table-styled">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Invoice No.</th>
                  <th>Buyer</th>
                  <th>GSTIN</th>
                  <th>Total Qty</th>
                  <th>Grand Total (₹)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="historyBody">
                <tr>
                  <td colspan="7" style="text-align:center;">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2025 MUFIZ TRADERS | GST Invoice Generator System</p>
    </footer>
  </div>

  <script>
    const API_BASE = 'https://396sen1eal.execute-api.ap-south-1.amazonaws.com';

    function formatDate(d) {
      if (!d) return '';
      const date = new Date(d);
      if (isNaN(date.getTime())) return d;
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    async function loadHistory() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Loading...</td></tr>`;

      try {
        const res = await fetch(`${API_BASE}/invoices`);
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Failed to load history</td></tr>`;
          return;
        }
        const data = await res.json();
        const invoices = Array.isArray(data.invoices) ? data.invoices : [];

        if (invoices.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No invoices found yet</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        invoices.forEach((inv) => {
          const tr = document.createElement('tr');
          const downloadUrl = `${API_BASE}/invoice/${inv._id}/pdf`;
          tr.innerHTML = `
            <td>${formatDate(inv.invoiceDate || inv.createdAt)}</td>
            <td>${inv.invoiceNumber || ''}</td>
            <td>${inv.buyerName || ''}</td>
            <td>${inv.buyerGSTIN || ''}</td>
            <td class="numeric">${(inv.totalQty ?? '').toString()}</td>
            <td class="numeric">${(inv.grandTotal ?? '').toString()}</td>
            <td class="center">
              <a href="${downloadUrl}" target="_blank" rel="noopener" class="btn-link-small" style="margin-right:6px;">
                <i class="fas fa-download"></i><span>Download</span>
              </a>
              <button type="button" class="btn-link-small" style="border-color:#e74c3c; color:#c0392b;" onclick="deleteInvoice('${inv._id}')">
                <i class="fas fa-trash"></i><span>Delete</span>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error loading history</td></tr>`;
      }
    }

    async function deleteInvoice(id) {
      if (!confirm('Are you sure you want to delete this invoice?')) return;

      try {
        const res = await fetch(`${API_BASE}/invoice/${id}`, {
          method: 'DELETE',
        });

        if (!res.ok) {
          alert('Failed to delete invoice');
          return;
        }

        await loadHistory();
      } catch (err) {
        console.error(err);
        alert('Error deleting invoice');
      }
    }

    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>
